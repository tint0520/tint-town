<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tint ç¾æ¥­æ»‘æ»‘åœ°åœ–</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans TC', sans-serif;
    }
    #banner {
      background-color: #ffeef0;
      text-align: center;
      padding: 16px;
      font-size: 22px;
      font-weight: bold;
      color: #d06e6e;
      border-bottom: 2px solid #d06e6e44;
    }
    #popup {
      height: calc(100vh - 60px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #fff;
    }
    #popup h1 {
      color: #d06e6e;
    }
    #popup button {
      padding: 12px 24px;
      background-color: #d06e6e;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .view {
      display: none;
      flex-direction: column;
      height: calc(100vh - 60px);
    }
    #map-view {
      flex: 1;
    }
    #swipe-view {
      padding: 12px;
      overflow-y: auto;
      background: #fff7f9;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      padding: 12px;
    }
    .card img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .card h3 {
      margin: 4px 0;
      color: #d06e6e;
    }
    .card p {
      margin: 4px 0;
      font-size: 14px;
      color: #444;
    }
    .card a {
      display: inline-block;
      margin-right: 6px;
      font-size: 14px;
      color: #d06e6e;
      text-decoration: none;
    }
    .share-btn {
      float: right;
      border: none;
      background: none;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="banner">Tint åœ°åœ–ãƒ»æ»‘æ»‘é¸åº—</div>

  <div id="popup">
    <h1>æ­¡è¿ä¾†åˆ° Tint ç¾æ¥­åœ°åœ–</h1>
    <button onclick="startApp()">é–‹å§‹æ¢ç´¢é™„è¿‘åº—å®¶</button>
  </div>

  <div id="home-view" class="view">
    <button onclick="startExploring()">é€²å…¥åœ°åœ–æ¨¡å¼</button>
  </div>

  <div id="map-view" class="view">
    <div id="map" style="height: 50vh;"></div>
    <div id="swipe-view"></div>
  </div>

  <script>
    let map;
    let swipeData = [];
    let userPosition = null;
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/12nFTJltWKVTVVBOe5RC9wQ4GWqgqcCO1bFkR-qMFmjs/gviz/tq?tqx=out:json";

    function startApp() {
      document.getElementById("popup").style.display = "none";
      document.getElementById("home-view").style.display = "flex";
      switchView("home");
      getUserLocation();
    }

    function startExploring() {
      switchView('map');
      setTimeout(() => {
        getUserLocation();
        if (!map) initMap();
      }, 200);
    }

    function switchView(view) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.getElementById(`${view}-view`).style.display = 'flex';
    }

    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          userPosition = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };

          if (map) {
            map.setCenter(userPosition);
            map.setZoom(14);

            new google.maps.Marker({
              position: userPosition,
              map,
              title: "ä½ åœ¨é€™è£¡",
              icon: {
                url: 'https://github.com/tint0520/tint-town/blob/main/person_pin_circle_30dp_B2A8D3_FILL1_wght400_GRAD0_opsz24.png?raw=true',
                scaledSize: new google.maps.Size(44, 44)
              }
            });
          }

          loadSwipeData();
        });
      }
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 25.034, lng: 121.564 },
        zoom: 12,
      });
    }

    function getDistanceKm(lat1, lng1, lat2, lng2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lat2 - lng1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function loadSwipeData() {
      const res = await fetch(SHEET_URL);
      const raw = await res.text();
      const json = JSON.parse(raw.substring(47).slice(0, -2));
      const table = json.table.rows;

      swipeData = table.map(row => {
        const get = i => row.c[i]?.v || "";
        const latlng = get(8);
        if (!latlng.includes(",")) return null;
        const [lat, lng] = latlng.split(",").map(Number);
        const distance = userPosition ? getDistanceKm(userPosition.lat, userPosition.lng, lat, lng).toFixed(1) : "-";

        return {
          name: get(0),
          ig: get(1),
          type: get(2),
          tags: get(3),
          desc: get(4),
          line: get(5),
          phone: get(6),
          web: get(7),
          lat, lng,
          addr: get(9),
          photo: get(10),
          distance
        };
      }).filter(Boolean);

      swipeData.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
      renderSwipeCards();
    }

    function renderSwipeCards() {
      const container = document.getElementById("swipe-view");
      container.innerHTML = "";

      swipeData.forEach(store => {
        const card = document.createElement("div");
        card.className = "card";

        const photo = store.photo || "https://via.placeholder.com/300x200?text=No+Image";
        const shareLink = store.web || store.ig || store.line || window.location.href;

        card.innerHTML = `
          <button class="share-btn" onclick="shareStore('${store.name}', '${shareLink}')">ğŸ”—</button>
          <img src="${photo}" alt="åœ–ç‰‡" />
          <h3>${store.name}</h3>
          <p>${store.desc}</p>
          <p>ğŸ“ è·é›¢ä½ ç´„ ${store.distance} km</p>
          ${store.ig ? `<a href="${store.ig}" target="_blank">IG</a>` : "<span>æœªæä¾› IG</span>`}
          ${store.line ? `<a href="${store.line}" target="_blank">LINE</a>` : "<span>æœªæä¾› LINE</span>`}
          ${store.phone ? `<a href="tel:${store.phone}">ğŸ“ ${store.phone}</a>` : ""}
        `;

        container.appendChild(card);

        new google.maps.Marker({
          position: { lat: store.lat, lng: store.lng },
          map,
          title: store.name
        });
      });
    }

    function shareStore(name, link) {
      const shareLink = link || window.location.href;
      if (navigator.share) {
        navigator.share({ title: name, url: shareLink });
      } else {
        navigator.clipboard.writeText(shareLink).then(() => {
          alert("é€£çµå·²è¤‡è£½");
        });
      }
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM&callback=initMap"></script>
</body>
</html>
