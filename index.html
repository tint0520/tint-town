<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tint 地圖・滑滑選店</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#d06e6e">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Noto Sans TC', sans-serif;
      background: #fff7f9;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    header {
      background: #ffeef0;
      color: #d06e6e;
      text-align: center;
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      z-index: 1000;
    }
    #map {
      height: 50vh;
      width: 100%;
    }
    #swipe-view {
      flex: 1;
      background: #fff0f4;
      overflow-x: auto;
      display: flex;
      scroll-snap-type: x mandatory;
      gap: 16px;
      padding: 20px;
    }
    .card {
      flex: 0 0 80%;
      max-width: 320px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 16px;
      scroll-snap-align: start;
      display: flex;
      flex-direction: column;
    }
    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 8px;
    }
    .card h3 {
      font-size: 18px;
      color: #d06e6e;
      margin-bottom: 4px;
    }
    .card p {
      font-size: 14px;
      color: #555;
      margin: 2px 0;
    }
    .card a {
      font-size: 14px;
      color: #d06e6e;
      margin-top: 6px;
      text-decoration: underline;
    }
    .share-btn {
      align-self: flex-end;
      background: #f8d3dc;
      border: none;
      border-radius: 50%;
      padding: 8px;
      cursor: pointer;
      font-size: 16px;
      color: #d06e6e;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <header>Tint 地圖・滑滑選店</header>
  <div id="map"></div>
  <div id="swipe-view"></div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    let map;
    let swipeData = [];
    let userPosition = null;
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1YsGmD_2EtrwjypWZqMU1n9H_pn-6NhZQcawC_-CpAN8/gviz/tq?tqx=out:json";

    window.addEventListener('load', () => {
      navigator.geolocation.getCurrentPosition((pos) => {
        userPosition = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };
        initMap();
        loadSwipeData();
      }, () => {
        initMap();
        loadSwipeData();
      });
    });

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: userPosition || { lat: 25.034, lng: 121.564 },
        zoom: 13,
      });

      if (userPosition) {
        new google.maps.Marker({
          position: userPosition,
          map,
          title: "你在這裡",
          icon: {
            url: 'https://github.com/tint0520/tint-town/blob/main/person_pin_circle_30dp_B2A8D3_FILL1_wght400_GRAD0_opsz24.png?raw=true',
            scaledSize: new google.maps.Size(44, 44)
          }
        });
      }
    }

    function getDistanceKm(lat1, lng1, lat2, lng2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function loadSwipeData() {
      const res = await fetch(SHEET_URL);
      const raw = await res.text();
      const json = JSON.parse(raw.substring(47).slice(0, -2));
      const table = json.table.rows;

      swipeData = table.map(row => {
        const get = i => row.c[i]?.v || "";
        const latlng = get(8);
        if (!latlng.includes(",")) return null;
        const [lat, lng] = latlng.split(",").map(Number);
        const distance = userPosition ? getDistanceKm(userPosition.lat, userPosition.lng, lat, lng).toFixed(1) : "-";

        return {
          name: get(0),
          ig: get(1),
          type: get(2),
          tags: get(3),
          desc: get(4),
          line: get(5),
          phone: get(6),
          web: get(7),
          lat, lng,
          addr: get(9),
          photo: get(10),
          distance
        };
      }).filter(Boolean);

      swipeData.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
      renderSwipeCards();
    }

    function renderSwipeCards() {
      const container = document.getElementById("swipe-view");
      container.innerHTML = "";

      swipeData.forEach(store => {
        const card = document.createElement("div");
        card.className = "card";

        const photo = store.photo || "https://via.placeholder.com/300x200?text=No+Image";
        const shareLink = store.web || store.ig || store.line || window.location.href;

        card.innerHTML = `
          <button class="share-btn" onclick="shareStore('${store.name}', '${shareLink}')">🔗</button>
          <img src="${photo}" alt="圖片" />
          <h3>${store.name}</h3>
          <p>${store.desc}</p>
          <p>📍 距離你約 ${store.distance} km</p>
          ${store.ig ? `<a href="${store.ig}" target="_blank">IG</a>` : "<span>未提供 IG</span>"}
          ${store.line ? `<a href="${store.line}" target="_blank">LINE</a>` : "<span>未提供 LINE</span>"}
          ${store.phone ? `<a href="tel:${store.phone}">📞 ${store.phone}</a>` : ""}
        `;

        container.appendChild(card);

        new google.maps.Marker({
          position: { lat: store.lat, lng: store.lng },
          map,
          title: store.name
        });
      });
    }

    function shareStore(name, link) {
      const shareLink = link || window.location.href;
      if (navigator.share) {
        navigator.share({ title: name, url: shareLink });
      } else {
        navigator.clipboard.writeText(shareLink).then(() => {
          alert("連結已複製");
        });
      }
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM&callback=initMap"></script>
</body>
</html>
