<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tint Maps 美業地圖 App</title>

  <!-- 字型與框架 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"/>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; }

    #map-view, #card-view, #favorite-view { display: none; height: calc(100% - 110px); }

    .top-banner {
  width: 100%;
  height: 80px; /* 調整高度給兩行文字更多空間 */
  background-color: #ffe4ec; /* 原有淺粉色背景 */
  display: flex;
  flex-direction: column; /* 垂直排列 */
  align-items: center; /* 水平置中 */
  justify-content: center; /* 垂直置中 */
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

    .map-btn {
  color: #0d6efd; /* 藍色 */
  cursor: pointer;
  text-decoration: underline;
}

.map-btn:hover {
  color: #0a58ca;
}
   .store-distance {
  position: relative;  /* 改成相對位置，讓距離貼著上方資訊 */
  margin-top: 8px;     /* 距離上面店家資訊的間距 */
  font-size: 12px;
  color: #888;
  text-align: left;    /* 距離文字靠左對齊 */
  padding-left: 10px;  /* 跟上面資訊左側對齊 */
}
.banner-text {
  font-size: 24px; /* 主標題大小 */
  color: #d63384;
  font-weight: bold;
}

.banner-subtext {
  font-size: 14px; /* 次標題大小 */
  color: #888; /* 淺灰色文字 */
}
    #bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
      background: white; display: flex; border-radius: 15px 15px 0 0;
      box-shadow: 0 -3px 10px rgba(0,0,0,0.15); z-index: 10;
    }

    .nav-btn { flex: 1; padding: 10px; text-align: center; color: #555; font-size:14px; }

    .swiper-container { height: 55%; padding-top: 10px; }

    .swiper-slide {
      width: 80%; border-radius: 12px; box-shadow: 0 1.6px 6.4px rgba(0,0,0,0.15);
      overflow-y: auto; background-color: ffeff3;
    }

    .swiper-slide img { height: 220px; object-fit: cover; width: 100%; }  // 卡片圖片高度

    .store-info { padding: 10px; font-size:14px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
 <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM&callback=initMap&loading=async"></script>
  <script defer>
   const SHEET_URL = "https://docs.google.com/spreadsheets/d/1iKVLOjHA2w29Y96Hlg78hgivnjV-ntx2LJvhFpeiFUs/export?format=csv&gid=0";

    let map;
let markers = []; 
let stores = [];
let userLocation;
    
function initMap() {
  map = new google.maps.Map(document.getElementById("map-view"), {
    center: { lat: 25.034, lng: 121.564 },
zoom: 14,   // ← 這裡要加上逗號 (,)
    streetViewControl: false,     // 移除黃色小人（街景功能）
  mapTypeControl: false,        // 移除衛星地圖等切換按鈕
  fullscreenControl: false      // 移除全螢幕按鈕（可選移除）
  });

  navigator.geolocation.getCurrentPosition(pos => {
    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    map.setCenter(userLocation);
    
    // 建立使用者位置標記（使用你提供的新圖標）
    new google.maps.Marker({
      position: userLocation,
      map,
      title: "你的位置",
      icon: {
        url: "https://github.com/tint0520/tint-town/blob/main/person_pin_circle_30dp_B2A8D3_FILL1_wght400_GRAD0_opsz24.png?raw=true",
        scaledSize: new google.maps.Size(35, 35)
      }
    });

    loadStoreData(); // 載入店家資料
  }, () => {
    alert('無法取得你的定位，距離功能將無法使用。');
    loadStoreData();
  });

  showView('map-view');
}

    function loadStoreData() {
  Papa.parse(SHEET_URL, { download: true, header: true, complete: results => {
    stores = results.data;
    markers.forEach(m => m.setMap(null)); 
    markers = [];

    stores.forEach((store, index) => {
      if (!store.latlng) return;
      const [lat, lng] = store.latlng.split(",").map(Number);
      store.distance = userLocation ? calcDistance(userLocation.lat, userLocation.lng, lat, lng) : '--';

      // 建立店家圖標(marker)並放到地圖上
      const marker = new google.maps.Marker({ 
  position: { lat, lng }, 
  map, 
  title: store.name,
  icon: {
    url: "https://github.com/tint0520/tint-town/blob/main/local_mall_30dp_EECECD_FILL1_wght400_GRAD0_opsz24.png?raw=true",
    scaledSize: new google.maps.Size(35, 35), // 自訂圖標大小（你可調整數值）
  }
});

      // 點擊地圖圖標(marker)後跳出該店家卡片
      marker.addListener('click', () => {
        showCardForStore(index); // 點擊後顯示對應的店家卡片
      });

      markers.push(marker);
    });

    // 叢集功能
    new markerClusterer.MarkerClusterer({ markers, map });

    stores.sort((a, b) => a.distance - b.distance);
    initSwiper();
  }});
}
function showMapMarker(index) {
  const store = stores[index];
  const [lat, lng] = store.latlng.split(",").map(Number);

  // 切換回地圖
  showView('map-view');

  // 移動地圖中心至店家位置
  map.setCenter({lat, lng});
  map.setZoom(17); // 調整地圖縮放程度（可自訂）
}

 function calcDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(2);
  }

  let swiper; // ← 新增的變數 (Swiper的實體)

  function initSwiper() {
  document.querySelector('.swiper-wrapper').innerHTML = stores.map((store, index) => `
    <div class="swiper-slide">
      <div style="position: relative;">
        <img src="${store.photo}" alt="${store.name}">
      </div>
      <div class="store-info">
        <h5>${store.name}</h5>
        <p>簡介：${store.desc}</p>
        <p>服務：${store.type}</p>
        <p>標籤：${store.tags}</p>
        <p>地址：${store.address}</p>
        <p>營業時間：${store.hours}</p>
        <p>
          <a href="${store.link}">🔗我要預約</a> | 
          <a href="${store.ig}">📸Instagram</a> | 
          <a href="${store.line}">💬LINE</a>
        </p>
      </div>
      <div class="store-distance">
        距離：${store.distance} km | 
        <span class="map-btn" data-index="${index}">🗺️地圖位置</span> | 
        <a href="https://www.google.com/maps/dir/?api=1&destination=${store.latlng}" target="_blank">🚗導航</a>
      </div>
    </div>`).join('');

  swiper = new Swiper('.swiper-container', { 
    slidesPerView: 'auto', 
    spaceBetween: 15, 
    centeredSlides: true 
  });

  document.querySelectorAll('.map-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const index = btn.getAttribute('data-index');
      showMapMarker(index);
    });
  });
}

  function showView(viewId) {
    ['map-view','card-view','favorite-view'].forEach(id=>{
      document.getElementById(id).style.display=(id===viewId)?'block':'none';
    });
  }

  function showCardForStore(index) {
    showView('card-view');
    swiper.slideTo(index, 500, true);
  }

</script>
</head>
<body>
  <div class="top-banner">
  <div class="banner-text">Tint Maps</div>
  <div class="banner-subtext">找附近的美業店家</div>
</div>

  <div id="map-view"></div>
  <div id="card-view" class="swiper-container">
    <div class="swiper-wrapper"></div>
  </div>

  <div id="favorite-view" class="p-4">我的收藏（尚未開發）</div>

  <div id="bottom-nav">
    <div class="nav-btn" onclick="showView('map-view')">🗺️<br>地圖找店</div>
    <div class="nav-btn" onclick="showView('card-view')">📸<br>卡片探店</div>
    <div class="nav-btn" onclick="showView('favorite-view')">❤️<br>我的收藏</div>
  </div>

</body>
</html>
