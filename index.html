<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tint Town åœ°åœ– + æ»‘å¡è·é›¢ç¯©é¸æ¨¡å¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      font-family: 'Noto Sans TC', sans-serif;
      background: #fff7f9;
      overflow: hidden;
    }
    .view {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      display: none;
    }
    #map-view { z-index: 1; }
    #swipe-view {
      background: #fff0f4;
      z-index: 2;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
    }
    .card {
      width: 90%;
      max-width: 360px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.1);
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .card.slide-left { transform: translateX(-100%); opacity: 0; }
    .card.slide-right { transform: translateX(100%); opacity: 0; }
    .card img {
      width: 100%;
      border-radius: 12px;
      height: 200px;
      object-fit: cover;
    }
    .card h3 {
      margin: 10px 0 4px;
      color: #d06e6e;
    }
    .card p {
      font-size: 14px;
      color: #555;
      margin: 4px 0;
    }
    .card a {
      display: inline-block;
      margin: 6px;
      font-size: 14px;
      color: #d06e6e;
      text-decoration: underline;
    }
    #controls {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #controls button, #filter-bar select {
      background: #ffe6eb;
      color: #d06e6e;
      border: none;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    #filter-bar {
      position: fixed;
      top: 120px;
      left: 20px;
      z-index: 999;
    }
    #popup {
      position: fixed;
      z-index: 9999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
    }
    #popup p {
      font-size: 18px;
      color: #444;
      margin-bottom: 20px;
    }
    #popup button {
      background: #d06e6e;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="popup">
    <p>ğŸ“ ç‚ºäº†æ¨è–¦ä½ é™„è¿‘çš„åº—å®¶<br>è«‹å…è¨±æˆ‘å€‘å–å¾—ä½ çš„å®šä½</p>
    <button onclick="startApp()">å¥½å•Šï¼Œé–‹é€›ï¼</button>
  </div>

  <div id="controls">
    <button onclick="switchView('home')">ğŸ  é¦–é </button>
    <button onclick="switchView('map')">ğŸ—º åœ°åœ–æ¨¡å¼</button>
    <button onclick="switchView('swipe')">ğŸ’˜ æ»‘å¡æ¨¡å¼</button>
    <button onclick="goToMyLocation()">ğŸ“ æˆ‘åœ¨é€™é™„è¿‘</button>
  </div>

  <div id="filter-bar">
    <select id="typeFilter" onchange="applyTypeFilter()">
      <option value="">å…¨éƒ¨é¡å‹</option>
      <option value="ç¾ç”²">ç¾ç”²</option>
      <option value="ç¾ç«">ç¾ç«</option>
      <option value="ç´‹ç¹¡">ç´‹ç¹¡</option>
      <option value="çš®è†šç®¡ç†">çš®è†šç®¡ç†</option>
    </select>
  </div>

  <div id="map-view" class="view"></div>
  <div id="swipe-view" class="view"></div>
  <div id="home-view" class="view" style="z-index: 10; background: white; display: flex; justify-content: center; align-items: center; flex-direction: column;">
    <h1 style="font-size: 28px; color: #d06e6e; margin-bottom: 12px;">æ­¡è¿ä¾†åˆ° Tint Town</h1>
    <p style="color: #555; font-size: 16px; max-width: 300px; text-align: center;">ç«‹å³æ¢ç´¢é™„è¿‘æœ€ç¾çš„ç¾ç”²å·¥ä½œå®¤ï¼Œå¾åœ°åœ–ã€æ»‘å¡ã€åˆ°ä¸€éµåˆ†äº«</p>
    <button onclick="switchView('map')" style="margin-top: 20px; background: #d06e6e; color: white; border: none; padding: 10px 16px; border-radius: 20px; font-size: 16px;">é–‹å§‹æ¢ç´¢</button>
  </div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1YsGmD_2EtrwjypWZqMU1n9H_pn-6NhZQcawC_-CpAN8/gviz/tq?sheet=tint%20test";
    let map, userMarker, userLocation = null;
    let rawData = [], swipeData = [], currentCard = 0;

    function switchView(mode) {
      ['map-view','swipe-view','home-view'].forEach(id => document.getElementById(id).style.display = 'none');
      document.getElementById(`${mode}-view`).style.display = mode === 'map' ? 'block' : 'flex';
      if (mode === 'swipe') showSwipeCard(currentCard);
    }

    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return Math.round(R * c * 10) / 10;
    }

    async function startApp() {
      document.getElementById("popup").style.display = "none";
      map = new google.maps.Map(document.getElementById("map-view"), {
        center: { lat: 23.8, lng: 121 }, zoom: 7
      });
      const res = await fetch(SHEET_URL);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows;

      rawData = rows.map(row => ({
        name: row.c[0]?.v || '',
        link: row.c[1]?.v || '',
        type: row.c[2]?.v || '',
        tags: row.c[3]?.v || '',
        desc: row.c[4]?.v || '',
        latlng: row.c[5]?.v || '',
        address: row.c[6]?.v || '',
        photo: row.c[7]?.v || 'https://i.imgur.com/Vs6fE3r.png',
        ig: row.c[8]?.v || '',
        line: row.c[9]?.v || '',
        distance: 999
      }));

      swipeData = [...rawData];
      getUserLocation();
    }

    function getUserLocation() {
      if (!navigator.geolocation) return alert("ç„¡æ³•å–å¾—å®šä½è³‡è¨Š");
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        userLocation = { lat: latitude, lng: longitude };
        map.setCenter(userLocation);
        map.setZoom(16);
        if (!userMarker) {
          userMarker = new google.maps.Marker({
            position: userLocation,
            map,
            title: "ä½ çš„ä½ç½®",
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
          });
        } else {
          userMarker.setPosition(userLocation);
        }
        updateDistances();
        switchView('map');
      });
    }

    function goToMyLocation() {
      getUserLocation();
    }

    function applyTypeFilter() {
      const type = document.getElementById("typeFilter").value;
      swipeData = rawData.filter(d => !type || d.type === type);
      currentCard = 0;
      updateDistances();
    }

    function updateDistances() {
      if (!userLocation) return;
      swipeData.forEach(d => {
        if (!d.latlng.includes(",")) return;
        const [lat, lng] = d.latlng.split(",").map(Number);
        d.distance = getDistance(userLocation.lat, userLocation.lng, lat, lng);
      });
      swipeData.sort((a, b) => a.distance - b.distance);
      showSwipeCard(currentCard);
    }

    function showSwipeCard(i) {
      const d = swipeData[i];
      const view = document.getElementById('swipe-view');
      if (!d) return view.innerHTML = '<p>âœ¨ æ²’æœ‰æ›´å¤šæ¨è–¦äº†ï¼</p>';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
          <img src="${d.photo}" alt="åœ–">
          <h3>${d.name}</h3>
          <p>${d.desc}</p>
          <p>${d.address}</p>
          <p>ğŸ“ è·é›¢ä½ ç´„ ${d.distance} å…¬é‡Œ</p>
          ${d.link ? `<a href="${d.link}" target="_blank">ğŸ”— å®˜æ–¹ç¶²ç«™</a>` : ''}
          ${d.ig ? `<a href="${d.ig}" target="_blank">ğŸ“· IG</a>` : ''}
          ${d.line ? `<a href="${d.line}" target="_blank">ğŸ’¬ LINE</a>` : ''}
          <a href="https://line.me/R/msg/text/?${encodeURIComponent(`Tint æ¨è–¦åº—å®¶ï¼š${d.name}\n${d.desc}\n${d.address}\n${d.link}`)}" target="_blank">ğŸ“¤ åˆ†äº«åˆ° LINE</a>
        <div style="margin-top:16px;">
          ${i > 0 ? `<button onclick="prevCard()">â¬…ï¸ ä¸Šä¸€é–“</button>` : '<span style="color:#ccc">â¬…ï¸ å·¦æ»‘é‚„æ²’è§£é–</span>'}
          <button onclick="nextCard()">â¡ï¸ ä¸‹ä¸€é–“</button>
        </div>
      `;
      view.innerHTML = '';
      view.appendChild(card);
    }

    function nextCard() {
      const card = document.querySelector('.card');
      card.classList.add('slide-left');
      setTimeout(() => {
        if (currentCard < swipeData.length - 1) currentCard++;
        showSwipeCard(currentCard);
      }, 300);
    }

    function prevCard() {
      const card = document.querySelector('.card');
      card.classList.add('slide-right');
      setTimeout(() => {
        if (currentCard > 0) currentCard--;
        showSwipeCard(currentCard);
      }, 300);
    }

    window.initMap = () => {};
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM&callback=initMap">
  </script>
</body>
</html>
