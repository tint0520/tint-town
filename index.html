<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tint Maps 美業地圖 App</title>

  <!-- 載入字型（Google Fonts） -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">

  <!-- 載入 Bootstrap CSS (響應式框架) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* 設定頁面基本樣式，讓地圖填滿整個頁面 */
    html, body, #map-view { height: 100%; }
    body { font-family: 'Noto Sans TC', sans-serif; }

    /* 固定在頁面底部的導航列 */
    #bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    .nav-btn { flex: 1; padding: 10px; text-align: center; color: #555; }

    /* 控制視圖顯示與隱藏 */
    .view { display: none; padding-bottom: 60px; }
    .active-view { display: flex; flex-direction: column; }

    /* 頁面標頭樣式 */
    #app-header { padding: 20px; text-align: center; background-color: #f8f9fa; }

    /* 收藏按鈕樣式 */
    .favorite-btn { cursor: pointer; color: #e74c3c; }
  </style>

  <!-- 載入 CSV 資料處理套件 (PapaParse) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- 載入 MarkerClusterer 套件 -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

  <!-- Google Maps JavaScript API（記得換上你的API金鑰） -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM鑰&callback=initMap"></script>

  <script defer>
    // 設定你的 Google Sheets CSV 連結
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1iKVLOjHA2w29Y96Hlg78hgivnjV-ntx2LJvhFpeiFUs/export?format=csv&gid=0";

    let map; // 存放地圖的變數

    // 初始化地圖
    function initMap() {
      map = new google.maps.Map(document.getElementById("map-view"), {
        center: { lat: 25.034, lng: 121.564 },
        zoom: 12,
      });
      loadStoreData(); // 載入店家資料到地圖上
    }

    // 從Google Sheets載入店家資料並顯示在地圖上
    function loadStoreData() {
      Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
          const markers = [];

          results.data.forEach(store => {
            if (!store.latlng || !store.latlng.includes(",")) return;
            const [lat, lng] = store.latlng.split(",").map(Number);

            // 建立店家地圖標記
            const marker = new google.maps.Marker({ position: { lat, lng }, title: store.name });

            // 點擊地圖標記時顯示的店家資訊視窗（含收藏按鈕）
            const infoContent = `
              <h6>${store.name}</h6>
              <p>${store.desc || ''}</p>
              <p>📍 ${store.address || ''}</p>
              <p>⏰ ${store.hours || ''}</p>
              ${store.photo ? `<img src="${store.photo}" class="img-fluid rounded">` : ''}
              <br><button class="favorite-btn btn btn-light" onclick="toggleFavorite('${store.name}')">❤️ 收藏/取消收藏</button>
            `;

            const infoWindow = new google.maps.InfoWindow({ content: infoContent });
            marker.addListener('click', () => infoWindow.open(map, marker));

            markers.push(marker);
          });

          // 將標記群組化，使用 MarkerClusterer 優化地圖效能
          new markerClusterer.MarkerClusterer({ markers, map });
        }
      });
    }

    // 收藏或取消收藏店家
    function toggleFavorite(storeName) {
      let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      if (favorites.includes(storeName)) {
        favorites = favorites.filter(name => name !== storeName);
        alert(`${storeName} 已從收藏中移除`);
      } else {
        favorites.push(storeName);
        alert(`${storeName} 已加入收藏！`);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    // 開始使用App，隱藏初始彈窗並顯示首頁
    function startApp() { 
      document.getElementById("popup").style.display = "none"; 
      switchView("home"); 
    }

    // 開始探索，切換到地圖頁面
    function startExploring() { switchView('map'); }

    // 視圖切換函數（首頁與地圖間切換）
    function switchView(view) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
      document.getElementById(`${view}-view`).classList.add('active-view');
    }
  </script>
</head>
<body>
  <!-- 頁面頂部標頭區域 -->
  <div id="app-header">
    <h5>Tint Maps</h5>
    <p>找附近的美業店家</p>
  </div>

  <!-- 首頁內容區域 -->
  <div id="home-view" class="view active-view container">
    <h4 class="mt-4">歡迎來到 Tint Town</h4>
    <p>立即探索附近最美的美甲工作室，輕鬆從地圖找到你想去的店家</p>
    <button class="btn btn-primary mt-3" onclick="startExploring()">開始探索</button>
  </div>

  <!-- 地圖顯示區域 -->
  <div id="map-view" class="view"></div>

  <!-- 頁面底部導航列 -->
  <div id="bottom-nav" class="d-flex">
    <div class="nav-btn" onclick="switchView('home')">🏠<br>首頁</div>
    <div class="nav-btn" onclick="switchView('map')">🗺<br>地圖</div>
  </div>
</body>
</html>
