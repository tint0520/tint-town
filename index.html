<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tint Maps ç¾æ¥­åœ°åœ– App</title>

  <!-- å­—å‹èˆ‡æ¡†æ¶ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"/>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; }

    #map-view, #card-view, #favorite-view { display: none; height: calc(100% - 110px); }

    .top-banner {
  width: 100%;
  height: 80px; /* èª¿æ•´é«˜åº¦çµ¦å…©è¡Œæ–‡å­—æ›´å¤šç©ºé–“ */
  background-color: #ffe4ec; /* åŸæœ‰æ·ºç²‰è‰²èƒŒæ™¯ */
  display: flex;
  flex-direction: column; /* å‚ç›´æ’åˆ— */
  align-items: center; /* æ°´å¹³ç½®ä¸­ */
  justify-content: center; /* å‚ç›´ç½®ä¸­ */
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

    .map-btn {
  color: #0d6efd; /* è—è‰² */
  cursor: pointer;
  text-decoration: underline;
}

.map-btn:hover {
  color: #0a58ca;
}
   .store-distance {
  position: relative;  /* æ”¹æˆç›¸å°ä½ç½®ï¼Œè®“è·é›¢è²¼è‘—ä¸Šæ–¹è³‡è¨Š */
  margin-top: 8px;     /* è·é›¢ä¸Šé¢åº—å®¶è³‡è¨Šçš„é–“è· */
  font-size: 12px;
  color: #888;
  text-align: left;    /* è·é›¢æ–‡å­—é å·¦å°é½Š */
  padding-left: 10px;  /* è·Ÿä¸Šé¢è³‡è¨Šå·¦å´å°é½Š */
}
.banner-text {
  font-size: 24px; /* ä¸»æ¨™é¡Œå¤§å° */
  color: #d63384;
  font-weight: bold;
}

.banner-subtext {
  font-size: 14px; /* æ¬¡æ¨™é¡Œå¤§å° */
  color: #888; /* æ·ºç°è‰²æ–‡å­— */
}
    #bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
      background: white; display: flex; border-radius: 15px 15px 0 0;
      box-shadow: 0 -3px 10px rgba(0,0,0,0.15); z-index: 10;
    }

    .nav-btn { flex: 1; padding: 10px; text-align: center; color: #555; font-size:14px; }

    .swiper-container { height: 55%; padding-top: 10px; }

    .swiper-slide {
      width: 80%; border-radius: 12px; box-shadow: 0 1.6px 6.4px rgba(0,0,0,0.15);
      overflow-y: auto; background-color: ffeff3;
    }

    .swiper-slide img { height: 220px; object-fit: cover; width: 100%; }  // å¡ç‰‡åœ–ç‰‡é«˜åº¦

    .store-info { padding: 10px; font-size:14px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
 <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM&callback=initMap&loading=async"></script>
  <script defer>
   const SHEET_URL = "https://docs.google.com/spreadsheets/d/1iKVLOjHA2w29Y96Hlg78hgivnjV-ntx2LJvhFpeiFUs/export?format=csv&gid=0";

    let map;
let markers = []; 
let stores = [];
let userLocation;
    
function initMap() {
  map = new google.maps.Map(document.getElementById("map-view"), {
    center: { lat: 25.034, lng: 121.564 },
zoom: 14,   // â† é€™è£¡è¦åŠ ä¸Šé€—è™Ÿ (,)
    streetViewControl: false,     // ç§»é™¤é»ƒè‰²å°äººï¼ˆè¡—æ™¯åŠŸèƒ½ï¼‰
  mapTypeControl: false,        // ç§»é™¤è¡›æ˜Ÿåœ°åœ–ç­‰åˆ‡æ›æŒ‰éˆ•
  fullscreenControl: false      // ç§»é™¤å…¨è¢å¹•æŒ‰éˆ•ï¼ˆå¯é¸ç§»é™¤ï¼‰
  });

  navigator.geolocation.getCurrentPosition(pos => {
    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    map.setCenter(userLocation);
    
    // å»ºç«‹ä½¿ç”¨è€…ä½ç½®æ¨™è¨˜ï¼ˆä½¿ç”¨ä½ æä¾›çš„æ–°åœ–æ¨™ï¼‰
    new google.maps.Marker({
      position: userLocation,
      map,
      title: "ä½ çš„ä½ç½®",
      icon: {
        url: "https://github.com/tint0520/tint-town/blob/main/person_pin_circle_30dp_B2A8D3_FILL1_wght400_GRAD0_opsz24.png?raw=true",
        scaledSize: new google.maps.Size(35, 35)
      }
    });

    loadStoreData(); // è¼‰å…¥åº—å®¶è³‡æ–™
  }, () => {
    alert('ç„¡æ³•å–å¾—ä½ çš„å®šä½ï¼Œè·é›¢åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ã€‚');
    loadStoreData();
  });

  showView('map-view');
}

    function loadStoreData() {
  Papa.parse(SHEET_URL, { download: true, header: true, complete: results => {
    stores = results.data;
    markers.forEach(m => m.setMap(null)); 
    markers = [];

    stores.forEach((store, index) => {
      if (!store.latlng) return;
      const [lat, lng] = store.latlng.split(",").map(Number);
      store.distance = userLocation ? calcDistance(userLocation.lat, userLocation.lng, lat, lng) : '--';

      // å»ºç«‹åº—å®¶åœ–æ¨™(marker)ä¸¦æ”¾åˆ°åœ°åœ–ä¸Š
      const marker = new google.maps.Marker({ 
  position: { lat, lng }, 
  map, 
  title: store.name,
  icon: {
    url: "https://github.com/tint0520/tint-town/blob/main/local_mall_30dp_EECECD_FILL1_wght400_GRAD0_opsz24.png?raw=true",
    scaledSize: new google.maps.Size(35, 35), // è‡ªè¨‚åœ–æ¨™å¤§å°ï¼ˆä½ å¯èª¿æ•´æ•¸å€¼ï¼‰
  }
});

      // é»æ“Šåœ°åœ–åœ–æ¨™(marker)å¾Œè·³å‡ºè©²åº—å®¶å¡ç‰‡
      marker.addListener('click', () => {
        showCardForStore(index); // é»æ“Šå¾Œé¡¯ç¤ºå°æ‡‰çš„åº—å®¶å¡ç‰‡
      });

      markers.push(marker);
    });

    // å¢é›†åŠŸèƒ½
    new markerClusterer.MarkerClusterer({ markers, map });

    stores.sort((a, b) => a.distance - b.distance);
    initSwiper();
  }});
}
function showMapMarker(index) {
  const store = stores[index];
  const [lat, lng] = store.latlng.split(",").map(Number);

  // åˆ‡æ›å›åœ°åœ–
  showView('map-view');

  // ç§»å‹•åœ°åœ–ä¸­å¿ƒè‡³åº—å®¶ä½ç½®
  map.setCenter({lat, lng});
  map.setZoom(17); // èª¿æ•´åœ°åœ–ç¸®æ”¾ç¨‹åº¦ï¼ˆå¯è‡ªè¨‚ï¼‰
}

 function calcDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(2);
  }

  let swiper; // â† æ–°å¢çš„è®Šæ•¸ (Swiperçš„å¯¦é«”)

  function initSwiper() {
  document.querySelector('.swiper-wrapper').innerHTML = stores.map((store, index) => `
    <div class="swiper-slide">
      <div style="position: relative;">
        <img src="${store.photo}" alt="${store.name}">
      </div>
      <div class="store-info">
        <h5>${store.name}</h5>
        <p>ç°¡ä»‹ï¼š${store.desc}</p>
        <p>æœå‹™ï¼š${store.type}</p>
        <p>æ¨™ç±¤ï¼š${store.tags}</p>
        <p>åœ°å€ï¼š${store.address}</p>
        <p>ç‡Ÿæ¥­æ™‚é–“ï¼š${store.hours}</p>
        <p>
          <a href="${store.link}">ğŸ”—æˆ‘è¦é ç´„</a> | 
          <a href="${store.ig}">ğŸ“¸Instagram</a> | 
          <a href="${store.line}">ğŸ’¬LINE</a>
        </p>
      </div>
      <div class="store-distance">
        è·é›¢ï¼š${store.distance} km | 
        <span class="map-btn" data-index="${index}">ğŸ—ºï¸åœ°åœ–ä½ç½®</span> | 
        <a href="https://www.google.com/maps/dir/?api=1&destination=${store.latlng}" target="_blank">ğŸš—å°èˆª</a>
      </div>
    </div>`).join('');

  swiper = new Swiper('.swiper-container', { 
    slidesPerView: 'auto', 
    spaceBetween: 15, 
    centeredSlides: true 
  });

  document.querySelectorAll('.map-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const index = btn.getAttribute('data-index');
      showMapMarker(index);
    });
  });
}

  function showView(viewId) {
    ['map-view','card-view','favorite-view'].forEach(id=>{
      document.getElementById(id).style.display=(id===viewId)?'block':'none';
    });
  }

  function showCardForStore(index) {
    showView('card-view');
    swiper.slideTo(index, 500, true);
  }

</script>
</head>
<body>
  <div class="top-banner">
  <div class="banner-text">Tint Maps</div>
  <div class="banner-subtext">æ‰¾é™„è¿‘çš„ç¾æ¥­åº—å®¶</div>
</div>

  <div id="map-view"></div>
  <div id="card-view" class="swiper-container">
    <div class="swiper-wrapper"></div>
  </div>

  <div id="favorite-view" class="p-4">æˆ‘çš„æ”¶è—ï¼ˆå°šæœªé–‹ç™¼ï¼‰</div>

  <div id="bottom-nav">
    <div class="nav-btn" onclick="showView('map-view')">ğŸ—ºï¸<br>åœ°åœ–æ‰¾åº—</div>
    <div class="nav-btn" onclick="showView('card-view')">ğŸ“¸<br>å¡ç‰‡æ¢åº—</div>
    <div class="nav-btn" onclick="showView('favorite-view')">â¤ï¸<br>æˆ‘çš„æ”¶è—</div>
  </div>

</body>
</html>
