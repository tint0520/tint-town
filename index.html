<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tint Maps ç¾æ¥­åœ°åœ– App</title>

  <!-- è¼‰å…¥å­—å‹ï¼ˆGoogle Fontsï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">

  <!-- è¼‰å…¥ Bootstrap CSS (éŸ¿æ‡‰å¼æ¡†æ¶) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    html, body, #map-view { height: 100%; }
    body { font-family: 'Noto Sans TC', sans-serif; }

    #bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    .nav-btn { flex: 1; padding: 10px; text-align: center; color: #555; }

    .view { display: none; padding-bottom: 60px; }
    .active-view { display: flex; flex-direction: column; }

    #app-header { padding: 20px; text-align: center; background-color: #f8f9fa; }

    .favorite-btn { cursor: pointer; color: #e74c3c; }

    #search-bar {
      padding: 10px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #my-location-btn {
      position: absolute;
      bottom: 80px;
      right: 10px;
      z-index: 5;
    }

    .tag-btn {
      margin: 2px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #f1f1f1;
      border-radius: 5px;
      display: inline-block;
    }
    .tag-btn.active { background-color: #007bff; color: white; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNM&callback=initMap"></script>

  <script defer>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1iKVLOjHA2w29Y96Hlg78hgivnjV-ntx2LJvhFpeiFUs/export?format=csv&gid=0";

    let map;
    let markers = [];
    let allStores = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map-view"), {
        center: { lat: 25.034, lng: 121.564 },
        zoom: 12,
      });
      loadStoreData();
    }

    function loadStoreData() {
      Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
          markers = [];
          allStores = results.data;

          results.data.forEach(store => createMarker(store));
          new markerClusterer.MarkerClusterer({ markers, map });
          generateTagFilters();
        }
      });
    }

    function createMarker(store) {
      if (!store.latlng || !store.latlng.includes(",")) return;
      const [lat, lng] = store.latlng.split(",").map(Number);

      const marker = new google.maps.Marker({ position: { lat, lng }, title: store.name, map });

      const infoContent = `
        <h6>${store.name}</h6>
        <p>${store.desc || ''}</p>
        <p>ğŸ“ ${store.address || ''}</p>
        <p>â° ${store.hours || ''}</p>
        ${store.photo ? `<img src="${store.photo}" class="img-fluid rounded">` : ''}
        <br><button class="favorite-btn btn btn-light" onclick="toggleFavorite('${store.name}')">â¤ï¸ æ”¶è—/å–æ¶ˆæ”¶è—</button>
      `;

      const infoWindow = new google.maps.InfoWindow({ content: infoContent });
      marker.addListener('click', () => infoWindow.open(map, marker));

      markers.push(marker);
    }

    function toggleFavorite(storeName) {
      let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      if (favorites.includes(storeName)) {
        favorites = favorites.filter(name => name !== storeName);
        alert(`${storeName} å·²å¾æ”¶è—ä¸­ç§»é™¤`);
      } else {
        favorites.push(storeName);
        alert(`${storeName} å·²åŠ å…¥æ”¶è—ï¼`);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    function searchStores() {
      const query = document.getElementById('search-input').value.toLowerCase();
      markers.forEach(marker => marker.setVisible(marker.getTitle().toLowerCase().includes(query)));
    }

    function goToMyLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude });
        map.setZoom(15);
      }, () => alert('ç„¡æ³•å–å¾—ä½ çš„å®šä½'));
    }

    function generateTagFilters() {
      const tags = new Set(allStores.flatMap(store => store.tags?.split(",") || []));
      const tagContainer = document.getElementById('tag-filter');
      tags.forEach(tag => {
        const btn = document.createElement('span');
        btn.textContent = tag;
        btn.className = 'tag-btn';
        btn.onclick = () => filterByTag(tag, btn);
        tagContainer.appendChild(btn);
      });
    }

    function filterByTag(tag, btn) {
      document.querySelectorAll('.tag-btn').forEach(el => el.classList.remove('active'));
      btn.classList.add('active');
      markers.forEach((marker, i) => marker.setVisible(allStores[i].tags?.includes(tag)));
    }

    function switchView(view) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
      document.getElementById(`${view}-view`).classList.add('active-view');
    }
  </script>
</head>
<body>
  <div id="app-header"><h5>Tint Maps</h5><p>æ‰¾é™„è¿‘çš„ç¾æ¥­åº—å®¶</p></div>

  <div id="map-view" class="view active-view">
    <input id="search-input" class="form-control" placeholder="æœå°‹åº—å®¶åç¨±" oninput="searchStores()">
    <div id="tag-filter" class="p-2"></div>
    <button id="my-location-btn" class="btn btn-primary" onclick="goToMyLocation()">ğŸ“å›åˆ°æˆ‘çš„ä½ç½®</button>
  </div>

  <div id="bottom-nav" class="d-flex">
    <div class="nav-btn" onclick="switchView('map')">ğŸ—º<br>åœ°åœ–</div>
  </div>
</body>
</html>
