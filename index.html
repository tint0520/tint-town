<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tint Maps ç¾æ¥­åœ°åœ– App</title>

  <!-- è¼‰å…¥å­—å‹ï¼ˆGoogle Fontsï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">

  <!-- è¼‰å…¥ Bootstrap CSS (éŸ¿æ‡‰å¼æ¡†æ¶) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* è¨­å®šé é¢åŸºæœ¬æ¨£å¼ï¼Œè®“åœ°åœ–å¡«æ»¿æ•´å€‹é é¢ */
    html, body, #map-view { height: 100%; }
    body { font-family: 'Noto Sans TC', sans-serif; }

    /* å›ºå®šåœ¨é é¢åº•éƒ¨çš„å°èˆªåˆ— */
    #bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    .nav-btn { flex: 1; padding: 10px; text-align: center; color: #555; }

    /* æ§åˆ¶è¦–åœ–é¡¯ç¤ºèˆ‡éš±è— */
    .view { display: none; padding-bottom: 60px; }
    .active-view { display: flex; flex-direction: column; }

    /* é é¢æ¨™é ­æ¨£å¼ */
    #app-header { padding: 20px; text-align: center; background-color: #f8f9fa; }

    /* æ”¶è—æŒ‰éˆ•æ¨£å¼ */
    .favorite-btn { cursor: pointer; color: #e74c3c; }
  </style>

  <!-- è¼‰å…¥ CSV è³‡æ–™è™•ç†å¥—ä»¶ (PapaParse) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- è¼‰å…¥ MarkerClusterer å¥—ä»¶ -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

  <!-- Google Maps JavaScript APIï¼ˆè¨˜å¾—æ›ä¸Šä½ çš„APIé‡‘é‘°ï¼‰ -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLCB3EKFwsIqPwEEL_hxL7zluVpnzcCNMé‘°&callback=initMap"></script>

  <script defer>
    // è¨­å®šä½ çš„ Google Sheets CSV é€£çµ
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1iKVLOjHA2w29Y96Hlg78hgivnjV-ntx2LJvhFpeiFUs/export?format=csv&gid=0";

    let map; // å­˜æ”¾åœ°åœ–çš„è®Šæ•¸

    // åˆå§‹åŒ–åœ°åœ–
    function initMap() {
      map = new google.maps.Map(document.getElementById("map-view"), {
        center: { lat: 25.034, lng: 121.564 },
        zoom: 12,
      });
      loadStoreData(); // è¼‰å…¥åº—å®¶è³‡æ–™åˆ°åœ°åœ–ä¸Š
    }

    // å¾Google Sheetsè¼‰å…¥åº—å®¶è³‡æ–™ä¸¦é¡¯ç¤ºåœ¨åœ°åœ–ä¸Š
    function loadStoreData() {
      Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
          const markers = [];

          results.data.forEach(store => {
            if (!store.latlng || !store.latlng.includes(",")) return;
            const [lat, lng] = store.latlng.split(",").map(Number);

            // å»ºç«‹åº—å®¶åœ°åœ–æ¨™è¨˜
            const marker = new google.maps.Marker({ position: { lat, lng }, title: store.name });

            // é»æ“Šåœ°åœ–æ¨™è¨˜æ™‚é¡¯ç¤ºçš„åº—å®¶è³‡è¨Šè¦–çª—ï¼ˆå«æ”¶è—æŒ‰éˆ•ï¼‰
            const infoContent = `
              <h6>${store.name}</h6>
              <p>${store.desc || ''}</p>
              <p>ğŸ“ ${store.address || ''}</p>
              <p>â° ${store.hours || ''}</p>
              ${store.photo ? `<img src="${store.photo}" class="img-fluid rounded">` : ''}
              <br><button class="favorite-btn btn btn-light" onclick="toggleFavorite('${store.name}')">â¤ï¸ æ”¶è—/å–æ¶ˆæ”¶è—</button>
            `;

            const infoWindow = new google.maps.InfoWindow({ content: infoContent });
            marker.addListener('click', () => infoWindow.open(map, marker));

            markers.push(marker);
          });

          // å°‡æ¨™è¨˜ç¾¤çµ„åŒ–ï¼Œä½¿ç”¨ MarkerClusterer å„ªåŒ–åœ°åœ–æ•ˆèƒ½
          new markerClusterer.MarkerClusterer({ markers, map });
        }
      });
    }

    // æ”¶è—æˆ–å–æ¶ˆæ”¶è—åº—å®¶
    function toggleFavorite(storeName) {
      let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      if (favorites.includes(storeName)) {
        favorites = favorites.filter(name => name !== storeName);
        alert(`${storeName} å·²å¾æ”¶è—ä¸­ç§»é™¤`);
      } else {
        favorites.push(storeName);
        alert(`${storeName} å·²åŠ å…¥æ”¶è—ï¼`);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
    }

    // é–‹å§‹ä½¿ç”¨Appï¼Œéš±è—åˆå§‹å½ˆçª—ä¸¦é¡¯ç¤ºé¦–é 
    function startApp() { 
      document.getElementById("popup").style.display = "none"; 
      switchView("home"); 
    }

    // é–‹å§‹æ¢ç´¢ï¼Œåˆ‡æ›åˆ°åœ°åœ–é é¢
    function startExploring() { switchView('map'); }

    // è¦–åœ–åˆ‡æ›å‡½æ•¸ï¼ˆé¦–é èˆ‡åœ°åœ–é–“åˆ‡æ›ï¼‰
    function switchView(view) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
      document.getElementById(`${view}-view`).classList.add('active-view');
    }
  </script>
</head>
<body>
  <!-- é é¢é ‚éƒ¨æ¨™é ­å€åŸŸ -->
  <div id="app-header">
    <h5>Tint Maps</h5>
    <p>æ‰¾é™„è¿‘çš„ç¾æ¥­åº—å®¶</p>
  </div>

  <!-- é¦–é å…§å®¹å€åŸŸ -->
  <div id="home-view" class="view active-view container">
    <h4 class="mt-4">æ­¡è¿ä¾†åˆ° Tint Town</h4>
    <p>ç«‹å³æ¢ç´¢é™„è¿‘æœ€ç¾çš„ç¾ç”²å·¥ä½œå®¤ï¼Œè¼•é¬†å¾åœ°åœ–æ‰¾åˆ°ä½ æƒ³å»çš„åº—å®¶</p>
    <button class="btn btn-primary mt-3" onclick="startExploring()">é–‹å§‹æ¢ç´¢</button>
  </div>

  <!-- åœ°åœ–é¡¯ç¤ºå€åŸŸ -->
  <div id="map-view" class="view"></div>

  <!-- é é¢åº•éƒ¨å°èˆªåˆ— -->
  <div id="bottom-nav" class="d-flex">
    <div class="nav-btn" onclick="switchView('home')">ğŸ <br>é¦–é </div>
    <div class="nav-btn" onclick="switchView('map')">ğŸ—º<br>åœ°åœ–</div>
  </div>
</body>
</html>
